<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Meta tag PWA -->
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <title>ScreenRec Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #0f172a; font-family: 'Segoe UI', sans-serif; overscroll-behavior: none; }
        canvas { max-width: 100%; max-height: 80vh; object-fit: contain; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="text-white h-screen flex flex-col overflow-hidden">

    <!-- Header App -->
    <div class="flex justify-between items-center p-4 bg-slate-800 border-b border-slate-700 select-none">
        <h1 class="font-bold text-lg flex items-center gap-2">
            <i class="fa-solid fa-video text-blue-500"></i> Recorder
        </h1>
        <!-- Tombol Install PWA (Akan muncul otomatis) -->
        <button id="btnInstall" class="hidden text-xs bg-white text-slate-900 px-3 py-1 rounded-full font-bold">
            <i class="fa-solid fa-download"></i> Install App
        </button>
    </div>

    <!-- Main Content -->
    <div class="flex-grow relative flex flex-col items-center justify-center p-2 bg-black">
        <div id="instruction" class="absolute text-center text-slate-500 pointer-events-none z-10">
            <i class="fa-solid fa-layer-group text-4xl mb-2"></i>
            <p>Preview akan muncul di sini</p>
        </div>
        
        <canvas id="mainCanvas" class="w-full h-full"></canvas>
        
        <video id="screenVid" autoplay muted playsinline class="hidden"></video>
        <video id="camVid" autoplay muted playsinline class="hidden"></video>
    </div>

    <!-- Controls Bottom Sheet -->
    <div class="bg-slate-800 p-4 rounded-t-2xl border-t border-slate-700 shadow-[0_-5px_20px_rgba(0,0,0,0.5)]">
        
        <div class="flex justify-center mb-4 gap-6">
            <label class="flex items-center gap-2 text-sm text-slate-300">
                <input type="checkbox" id="chkMic" checked class="accent-blue-500 w-4 h-4"> Mic
            </label>
            <label class="flex items-center gap-2 text-sm text-slate-300">
                <input type="checkbox" id="chkCam" checked class="accent-blue-500 w-4 h-4"> Cam
            </label>
        </div>

        <div class="space-y-3">
            <button id="btnStart" onclick="startRecording()" class="w-full py-3 bg-blue-600 active:bg-blue-700 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2">
                <i class="fa-solid fa-circle text-xs"></i> Mulai Rekam
            </button>

            <button id="btnStop" onclick="stopRecording()" class="hidden w-full py-3 bg-red-600 active:bg-red-700 rounded-xl font-bold text-lg shadow-lg animate-pulse">
                Stop
            </button>
            
            <a id="btnDownload" class="hidden w-full py-3 bg-emerald-600 active:bg-emerald-700 rounded-xl font-bold text-center block">
                Simpan Video
            </a>
        </div>
    </div>

    <!-- Logic Script -->
    <script>
        // --- PWA INSTALL LOGIC ---
        let deferredPrompt;
        const btnInstall = document.getElementById('btnInstall');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            btnInstall.classList.remove('hidden');
        });

        btnInstall.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    btnInstall.classList.add('hidden');
                }
                deferredPrompt = null;
            }
        });

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js');
        }

        // --- RECORDING LOGIC (Sama seperti sebelumnya) ---
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const screenVid = document.getElementById('screenVid');
        const camVid = document.getElementById('camVid');
        const btnStart = document.getElementById('btnStart');
        const btnStop = document.getElementById('btnStop');
        const btnDownload = document.getElementById('btnDownload');
        
        let mediaRecorder, chunks = [], streams = [], isRecording = false;
        let audioCtx, destNode;

        async function startRecording() {
            try {
                // Audio Context
                audioCtx = new AudioContext();
                destNode = audioCtx.createMediaStreamDestination();

                // 1. Get Screen
                const displayStream = await navigator.mediaDevices.getDisplayMedia({
                    video: { frameRate: { ideal: 30 } },
                    audio: true
                });
                screenVid.srcObject = displayStream;
                await screenVid.play();
                streams.push(displayStream);

                // Set Canvas Size dynamic
                const settings = displayStream.getVideoTracks()[0].getSettings();
                canvas.width = settings.width || window.innerWidth;
                canvas.height = settings.height || window.innerHeight;

                // Mix Screen Audio
                if (displayStream.getAudioTracks().length > 0) {
                    audioCtx.createMediaStreamSource(displayStream).connect(destNode);
                }

                displayStream.getVideoTracks()[0].onended = stopRecording;

                // 2. Get Cam & Mic
                if (document.getElementById('chkCam').checked || document.getElementById('chkMic').checked) {
                    const userStream = await navigator.mediaDevices.getUserMedia({
                        video: document.getElementById('chkCam').checked ? { facingMode: 'user', width: {ideal: 640} } : false,
                        audio: document.getElementById('chkMic').checked
                    });
                    streams.push(userStream);
                    
                    if (document.getElementById('chkCam').checked) {
                        camVid.srcObject = userStream;
                        await camVid.play();
                    }
                    if (document.getElementById('chkMic').checked) {
                        audioCtx.createMediaStreamSource(userStream).connect(destNode);
                    }
                }

                // 3. Start Loop
                isRecording = true;
                drawLoop();
                
                // 4. Start Recorder
                const canvasStream = canvas.captureStream(30);
                destNode.stream.getAudioTracks().forEach(t => canvasStream.addTrack(t));
                
                mediaRecorder = new MediaRecorder(canvasStream, { mimeType: 'video/webm;codecs=vp8' });
                mediaRecorder.ondataavailable = e => { if(e.data.size > 0) chunks.push(e.data); };
                mediaRecorder.onstop = saveFile;
                mediaRecorder.start();

                document.getElementById('instruction').classList.add('hidden');
                btnStart.classList.add('hidden');
                btnStop.classList.remove('hidden');

            } catch (err) {
                alert("Gagal: " + err.message);
            }
        }

        function drawLoop() {
            if (!isRecording) return;
            ctx.drawImage(screenVid, 0, 0, canvas.width, canvas.height);
            
            if (document.getElementById('chkCam').checked && camVid.srcObject) {
                const w = canvas.width * 0.25;
                const h = w; 
                const x = canvas.width - w - 20;
                const y = canvas.height - h - 20;
                
                ctx.save();
                ctx.beginPath();
                ctx.arc(x + w/2, y + h/2, w/2, 0, Math.PI*2);
                ctx.clip();
                ctx.drawImage(camVid, x, y, w, h);
                ctx.strokeStyle = "white";
                ctx.lineWidth = 5;
                ctx.stroke();
                ctx.restore();
            }
            requestAnimationFrame(drawLoop);
        }

        function stopRecording() {
            if (!isRecording) return;
            isRecording = false;
            mediaRecorder.stop();
            streams.forEach(s => s.getTracks().forEach(t => t.stop()));
            audioCtx.close();
            btnStop.classList.add('hidden');
        }

        function saveFile() {
            const blob = new Blob(chunks, {type: 'video/webm'});
            btnDownload.href = URL.createObjectURL(blob);
            btnDownload.download = `Rec_${Date.now()}.mp4`;
            btnDownload.classList.remove('hidden');
        }
    </script>
</body>
</html>

