<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Web Recorder</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .recording-pulse {
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .hidden-process { display: none; opacity: 0; pointer-events: none; }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-slate-800 border-b border-slate-700 py-4 px-4 sm:px-6 shadow-md z-10">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="bg-indigo-600 p-2 rounded-lg">
                    <i class="fa-solid fa-video text-white"></i>
                </div>
                <h1 class="text-lg sm:text-xl font-bold tracking-tight">Web<span class="text-indigo-400">Recorder</span></h1>
            </div>
            <div id="deviceBadge" class="text-xs font-mono bg-slate-700 px-2 py-1 rounded text-slate-400">
                Mendeteksi Perangkat...
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col items-center justify-center p-4">
        
        <div class="w-full max-w-4xl space-y-5">
            
            <!-- Notification Area -->
            <div id="msgArea" class="hidden p-4 rounded-lg flex items-start space-x-3 text-sm">
                <i class="fa-solid fa-circle-info mt-0.5"></i>
                <span id="msgText">Pesan sistem.</span>
            </div>

            <!-- Preview Container -->
            <div class="relative bg-black rounded-xl overflow-hidden shadow-2xl border border-slate-700 aspect-video group w-full">
                <!-- Placeholder -->
                <div id="placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-slate-500 space-y-3 p-4 text-center">
                    <div class="bg-slate-800 p-5 rounded-full mb-2">
                        <i id="modeIcon" class="fa-solid fa-camera text-3xl sm:text-4xl"></i>
                    </div>
                    <p id="modeText" class="text-base sm:text-lg font-medium text-white">Siap Merekam</p>
                    <p class="text-xs text-slate-400 max-w-md">
                        Klik tombol di bawah untuk memberikan izin akses.
                    </p>
                </div>

                <!-- Canvas Utama -->
                <canvas id="outputCanvas" class="w-full h-full object-contain hidden"></canvas>
                
                <!-- Timer Overlay -->
                <div id="recIndicator" class="absolute top-4 right-4 hidden items-center space-x-2 bg-black/60 backdrop-blur-sm px-3 py-1.5 rounded-full border border-red-500/30 z-20">
                    <div class="w-2.5 h-2.5 bg-red-500 rounded-full recording-pulse"></div>
                    <span id="timer" class="text-white font-mono text-sm font-bold">00:00</span>
                </div>
            </div>

            <!-- Controls -->
            <div class="bg-slate-800 rounded-xl p-5 border border-slate-700 shadow-lg">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 items-center">
                    
                    <!-- Settings -->
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <span class="flex items-center space-x-2 text-sm text-slate-300">
                                <i class="fa-solid fa-microphone w-5 text-center"></i>
                                <span>Mikrofon</span>
                            </span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="micToggle" class="sr-only peer" checked>
                                <div class="w-9 h-5 bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600"></div>
                            </label>
                        </div>

                        <!-- Opsi Cam (Hanya muncul di Desktop, di HP otomatis aktif jika mode vlog) -->
                        <div id="camOptionDiv" class="flex items-center justify-between">
                            <span class="flex items-center space-x-2 text-sm text-slate-300">
                                <i class="fa-solid fa-user w-5 text-center"></i>
                                <span>Kamera Wajah</span>
                            </span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="camToggle" class="sr-only peer" checked>
                                <div class="w-9 h-5 bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600"></div>
                            </label>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="flex flex-col gap-3">
                        <button id="btnStart" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-lg shadow-indigo-900/20 transition-all flex items-center justify-center space-x-2">
                            <i class="fa-solid fa-circle text-xs"></i>
                            <span>Mulai Rekam</span>
                        </button>

                        <button id="btnStop" class="hidden w-full py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-lg shadow-red-900/20 transition-all flex items-center justify-center space-x-2">
                            <i class="fa-solid fa-stop"></i>
                            <span>Stop & Simpan</span>
                        </button>
                    </div>
                </div>
            </div>

             <!-- Download Section -->
             <div id="downloadArea" class="hidden bg-emerald-900/30 border border-emerald-500/50 p-4 rounded-xl flex flex-col sm:flex-row items-center justify-between gap-3 animate-fade-in">
                <div class="text-center sm:text-left">
                    <h4 class="font-bold text-emerald-100 text-sm">Rekaman Selesai!</h4>
                </div>
                <a id="downloadLink" href="#" class="w-full sm:w-auto px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white text-sm rounded-lg font-medium transition-colors flex items-center justify-center space-x-2">
                    <i class="fa-solid fa-download"></i>
                    <span>Unduh Video</span>
                </a>
            </div>
            
        </div>
    </main>

    <!-- Hidden Video Elements -->
    <video id="mainVideo" autoplay muted playsinline class="hidden-process"></video>
    <video id="pipVideo" autoplay muted playsinline class="hidden-process"></video>

    <script>
        // --- Elements ---
        const btnStart = document.getElementById('btnStart');
        const btnStop = document.getElementById('btnStop');
        const micToggle = document.getElementById('micToggle');
        const camToggle = document.getElementById('camToggle');
        const camOptionDiv = document.getElementById('camOptionDiv');
        const outputCanvas = document.getElementById('outputCanvas');
        const ctx = outputCanvas.getContext('2d');
        const placeholder = document.getElementById('placeholder');
        const recIndicator = document.getElementById('recIndicator');
        const timerEl = document.getElementById('timer');
        const msgArea = document.getElementById('msgArea');
        const msgText = document.getElementById('msgText');
        const downloadArea = document.getElementById('downloadArea');
        const downloadLink = document.getElementById('downloadLink');
        const mainVideo = document.getElementById('mainVideo'); // Screen or Main Cam
        const pipVideo = document.getElementById('pipVideo');   // Secondary Cam (PIP)
        const deviceBadge = document.getElementById('deviceBadge');
        const modeText = document.getElementById('modeText');
        const modeIcon = document.getElementById('modeIcon');

        // --- State ---
        let mediaRecorder;
        let recordedChunks = [];
        let mainStream = null;
        let pipStream = null;
        let isRecording = false;
        let startTime, timerInterval, animationFrameId;
        let audioCtx, destAudioNode;
        
        // Detect Capability
        // Note: Checking functionality, not just user agent string for robustness
        const supportsScreenRecord = !!(navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia);
        const isMobile = !supportsScreenRecord; // Simplification for logic

        // --- Init UI based on Device ---
        function initDeviceUI() {
            if (isMobile) {
                deviceBadge.textContent = "Mode Mobile (Kamera Only)";
                deviceBadge.classList.add("text-orange-300");
                modeText.textContent = "Rekam Video (Kamera Depan)";
                modeIcon.className = "fa-solid fa-mobile-screen text-3xl sm:text-4xl";
                
                // Hide Picture-in-Picture cam toggle on mobile, as main view IS the cam
                camOptionDiv.style.display = 'none'; 
                camToggle.checked = true;
            } else {
                deviceBadge.textContent = "Mode Desktop (Layar + Cam)";
                deviceBadge.classList.add("text-blue-300");
                modeText.textContent = "Rekam Layar & Wajah";
                modeIcon.className = "fa-solid fa-desktop text-3xl sm:text-4xl";
            }
        }
        initDeviceUI();

        function showMessage(msg, type = 'error') {
            msgArea.classList.remove('hidden', 'bg-red-900/50', 'bg-blue-900/50', 'text-red-200', 'text-blue-200');
            if (type === 'error') {
                msgArea.classList.add('bg-red-900/50', 'text-red-200', 'border', 'border-red-500/50');
            } else {
                msgArea.classList.add('bg-blue-900/50', 'text-blue-200', 'border', 'border-blue-500/50');
            }
            msgText.textContent = msg;
            msgArea.classList.remove('hidden');
        }

        // --- Recording Logic ---

        async function startRecording() {
            msgArea.classList.add('hidden');
            downloadArea.classList.add('hidden');
            recordedChunks = [];

            try {
                audioCtx = new AudioContext();
                destAudioNode = audioCtx.createMediaStreamDestination();

                // --- 1. SET UP STREAMS BASED ON DEVICE ---
                
                if (isMobile) {
                    // --- MOBILE LOGIC (Camera Only) ---
                    try {
                        mainStream = await navigator.mediaDevices.getUserMedia({
                            video: { facingMode: "user", width: { ideal: 1280 }, height: { ideal: 720 } },
                            audio: micToggle.checked
                        });
                        
                        // Set Canvas Size
                        const settings = mainStream.getVideoTracks()[0].getSettings();
                        outputCanvas.width = settings.width || 640;
                        outputCanvas.height = settings.height || 480;
                        
                        mainVideo.srcObject = mainStream;
                        await mainVideo.play();
                        
                        // Connect Audio
                        if (mainStream.getAudioTracks().length > 0) {
                            const source = audioCtx.createMediaStreamSource(mainStream);
                            source.connect(destAudioNode);
                        }
                    } catch (e) {
                        throw new Error("Gagal akses kamera: " + e.message);
                    }

                } else {
                    // --- DESKTOP LOGIC (Screen + Optional Cam) ---
                    
                    // A. Get Screen
                    mainStream = await navigator.mediaDevices.getDisplayMedia({
                        video: { frameRate: 30 },
                        audio: true // System Audio
                    });
                    
                    // Canvas Setup
                    const settings = mainStream.getVideoTracks()[0].getSettings();
                    outputCanvas.width = settings.width || 1920;
                    outputCanvas.height = settings.height || 1080;
                    
                    mainVideo.srcObject = mainStream;
                    await mainVideo.play();

                    // Connect Screen Audio
                    if (mainStream.getAudioTracks().length > 0) {
                        const screenSource = audioCtx.createMediaStreamSource(mainStream);
                        screenSource.connect(destAudioNode);
                    }

                    // Stop logic if user clicks browser's "Stop Sharing"
                    mainStream.getVideoTracks()[0].onended = stopRecording;

                    // B. Get Camera (PIP)
                    if (camToggle.checked || micToggle.checked) {
                        try {
                            pipStream = await navigator.mediaDevices.getUserMedia({
                                video: camToggle.checked ? { width: 320, aspectRatio: 1.33 } : false,
                                audio: micToggle.checked
                            });

                            if (camToggle.checked) {
                                pipVideo.srcObject = pipStream;
                                await pipVideo.play();
                            }

                            if (micToggle.checked && pipStream.getAudioTracks().length > 0) {
                                // Important: Create stream with ONLY audio track for mixing
                                const micStreamOnly = new MediaStream(pipStream.getAudioTracks());
                                const micSource = audioCtx.createMediaStreamSource(micStreamOnly);
                                micSource.connect(destAudioNode);
                            }
                        } catch (err) {
                            console.warn("Cam/Mic issue:", err);
                            showMessage("Mic/Cam tidak dapat diakses, lanjut merekam layar saja.", "info");
                        }
                    }
                }

                // --- 2. START COMPOSITING & RECORDING ---
                
                drawCanvas(); // Start Loop

                // Combine Canvas Video + Mixed Audio
                const canvasStream = outputCanvas.captureStream(30);
                if (destAudioNode.stream.getAudioTracks().length > 0) {
                    destAudioNode.stream.getAudioTracks().forEach(track => canvasStream.addTrack(track));
                }

                // Codec selection for broad compatibility
                const options = { mimeType: 'video/webm;codecs=vp8,opus' };
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    delete options.mimeType; // Let browser pick default
                }

                mediaRecorder = new MediaRecorder(canvasStream, options);
                
                mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
                mediaRecorder.onstop = saveVideo;

                mediaRecorder.start();
                isRecording = true;
                startTime = Date.now();
                startTimer();

                // Update UI
                placeholder.classList.add('hidden');
                outputCanvas.classList.remove('hidden');
                recIndicator.classList.remove('hidden');
                recIndicator.classList.add('flex');
                btnStart.classList.add('hidden');
                btnStop.classList.remove('hidden');

            } catch (err) {
                console.error(err);
                showMessage(err.message || "Gagal memulai. Pastikan izin diberikan.");
                stopStreams();
            }
        }

        function stopRecording() {
            if (!isRecording) return;
            isRecording = false;
            mediaRecorder.stop();
            stopStreams();
            
            cancelAnimationFrame(animationFrameId);
            clearInterval(timerInterval);

            // UI Reset
            recIndicator.classList.add('hidden');
            btnStart.classList.remove('hidden');
            btnStop.classList.add('hidden');
        }

        function stopStreams() {
            [mainStream, pipStream].forEach(stream => {
                if (stream) stream.getTracks().forEach(t => t.stop());
            });
            if (audioCtx) audioCtx.close();
            mainStream = null;
            pipStream = null;
        }

        function saveVideo() {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const date = new Date();
            const timeStr = `${date.getHours()}${date.getMinutes()}${date.getSeconds()}`;
            
            downloadLink.href = url;
            downloadLink.download = `Rec_${isMobile ? 'Mobile' : 'Desktop'}_${timeStr}.webm`;
            downloadArea.classList.remove('hidden');
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                const diff = Math.floor((Date.now() - startTime) / 1000);
                const m = Math.floor(diff / 60).toString().padStart(2, '0');
                const s = (diff % 60).toString().padStart(2, '0');
                timerEl.textContent = `${m}:${s}`;
            }, 1000);
        }

        // --- The Composer Loop ---
        function drawCanvas() {
            if (!isRecording) return;

            // 1. Draw Main Background (Screen or Mobile Camera)
            // Use 'cover' strategy for Mobile Cam to fill canvas nicely
            ctx.drawImage(mainVideo, 0, 0, outputCanvas.width, outputCanvas.height);

            // 2. Draw PIP (Only for Desktop Mode + Cam Enabled)
            if (!isMobile && camToggle.checked && pipVideo.srcObject) {
                const w = outputCanvas.width;
                const h = outputCanvas.height;
                const pipW = w * 0.2; // 20% width
                const pipH = pipW * 0.75; // 4:3
                const pad = 20;

                const x = w - pipW - pad;
                const y = h - pipH - pad;

                // Draw Border
                ctx.strokeStyle = "white";
                ctx.lineWidth = 3;
                ctx.strokeRect(x, y, pipW, pipH);

                // Draw Video
                ctx.drawImage(pipVideo, x, y, pipW, pipH);
            }

            animationFrameId = requestAnimationFrame(drawCanvas);
        }

        // --- Event Listeners ---
        btnStart.addEventListener('click', startRecording);
        btnStop.addEventListener('click', stopRecording);
    </script>
</body>
</html>

