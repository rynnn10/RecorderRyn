<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Settings -->
    <meta name="theme-color" content="#0f172a">
    <link rel="manifest" href="manifest.json">
    <title>ScreenRec Smart</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #0f172a; font-family: sans-serif; }
        /* Agar video responsif di HP */
        canvas, video { max-width: 100%; max-height: 60vh; border-radius: 12px; }
    </style>
</head>
<body class="text-white min-h-screen flex flex-col">

    <!-- Header -->
    <nav class="p-4 bg-slate-800 border-b border-slate-700 flex justify-between items-center">
        <h1 class="font-bold flex items-center gap-2">
            <i class="fa-solid fa-video text-blue-500"></i> Recorder
        </h1>
        <div id="modeBadge" class="text-xs px-2 py-1 rounded bg-slate-700 text-slate-400">Loading...</div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col items-center justify-center p-4 gap-4">
        
        <!-- Pesan Warning Khusus PWA -->
        <div id="pwaWarning" class="hidden w-full bg-orange-900/40 border border-orange-500/50 p-4 rounded-xl text-sm text-orange-200">
            <i class="fa-solid fa-triangle-exclamation mr-2"></i>
            <strong>Mode Aplikasi Terdeteksi:</strong><br>
            Android memblokir "Rekam Layar" di mode Aplikasi.
            <ul class="list-disc list-inside mt-2 text-xs text-orange-300 opacity-80">
                <li>Anda hanya bisa merekam <b>Kamera Wajah</b> di sini.</li>
                <li>Untuk rekam layar, buka website ini lewat Chrome biasa.</li>
            </ul>
            <button onclick="window.open(window.location.href, '_system');" class="mt-3 bg-orange-700 text-white px-3 py-2 rounded text-xs font-bold w-full">
                <i class="fa-brands fa-chrome"></i> Buka di Chrome Browser
            </button>
        </div>

        <!-- Preview Canvas -->
        <canvas id="outputCanvas" class="bg-black border border-slate-700 hidden"></canvas>
        
        <!-- Placeholder -->
        <div id="placeholder" class="text-center text-slate-500 py-10">
            <i class="fa-solid fa-camera text-4xl mb-2"></i>
            <p>Siap Merekam</p>
        </div>

        <!-- Controls -->
        <div class="w-full bg-slate-800 p-4 rounded-xl space-y-3">
            
            <!-- Tombol Start Screen (Akan disembunyikan jika tidak support) -->
            <button id="btnScreen" onclick="startRecording('screen')" class="w-full py-3 bg-blue-600 rounded-lg font-bold shadow flex items-center justify-center gap-2">
                <i class="fa-solid fa-display"></i> Rekam Layar & Cam
            </button>

            <!-- Tombol Start Camera Only (Selalu muncul) -->
            <button id="btnCam" onclick="startRecording('cam')" class="w-full py-3 bg-slate-700 rounded-lg font-bold shadow flex items-center justify-center gap-2">
                <i class="fa-solid fa-user"></i> Rekam Kamera Saja
            </button>

            <button id="btnStop" onclick="stopRecording()" class="hidden w-full py-3 bg-red-600 rounded-lg font-bold animate-pulse">
                Stop & Simpan
            </button>

            <!-- Download Link -->
            <a id="downloadLink" class="hidden block w-full py-3 bg-green-600 text-center rounded-lg font-bold">
                Download Video
            </a>
        </div>
    </main>

    <!-- Hidden Video Elements -->
    <video id="sourceVideo" autoplay muted playsinline class="hidden"></video>
    <video id="pipVideo" autoplay muted playsinline class="hidden"></video>

    <script>
        // --- Setup PWA Service Worker ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(() => {});
        }

        // --- Elements ---
        const btnScreen = document.getElementById('btnScreen');
        const btnCam = document.getElementById('btnCam');
        const btnStop = document.getElementById('btnStop');
        const pwaWarning = document.getElementById('pwaWarning');
        const modeBadge = document.getElementById('modeBadge');
        
        const canvas = document.getElementById('outputCanvas');
        const ctx = canvas.getContext('2d');
        const sourceVideo = document.getElementById('sourceVideo');
        const pipVideo = document.getElementById('pipVideo');

        // --- Variabel Global ---
        let mediaRecorder;
        let chunks = [];
        let streams = [];
        let isRecording = false;
        let animationId;
        let activeMode = ''; // 'screen' atau 'cam'

        // --- 1. DETEKSI FITUR (Solusi Masalah Anda) ---
        function checkSupport() {
            // Cek apakah browser punya fungsi getDisplayMedia
            if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) {
                // Berhasil: Ini Browser Biasa / Desktop
                modeBadge.textContent = "Mode: Browser Support";
                modeBadge.classList.add("bg-green-900", "text-green-300");
                btnScreen.classList.remove('hidden'); // Tampilkan tombol rekam layar
            } else {
                // Gagal: Ini Mode PWA Android atau iPhone
                modeBadge.textContent = "Mode: App / Restricted";
                modeBadge.classList.add("bg-orange-900", "text-orange-300");
                
                // SEMBUNYIKAN TOMBOL REKAM LAYAR AGAR TIDAK ERROR
                btnScreen.classList.add('hidden'); 
                
                // Munculkan pesan peringatan
                pwaWarning.classList.remove('hidden');
                
                // Highlight tombol kamera sebagai satu-satunya opsi
                btnCam.classList.add('ring', 'ring-blue-500', 'ring-offset-2');
                btnCam.innerText = "Mulai Rekam (Kamera Saja)";
            }
        }

        // Jalankan pengecekan saat loading
        checkSupport();

        // --- 2. Start Recording Logic ---
        async function startRecording(mode) {
            activeMode = mode;
            chunks = [];
            
            try {
                let mainStream;

                if (mode === 'screen') {
                    // Logic Rekam Layar (Hanya jalan di Browser)
                    mainStream = await navigator.mediaDevices.getDisplayMedia({
                        video: { frameRate: 30 },
                        audio: true
                    });
                } else {
                    // Logic Rekam Kamera (Jalan di PWA & Browser)
                    mainStream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'user', width: { ideal: 720 } },
                        audio: true
                    });
                }
                
                streams.push(mainStream);
                sourceVideo.srcObject = mainStream;
                await sourceVideo.play();

                // Setup Canvas Size
                const settings = mainStream.getVideoTracks()[0].getSettings();
                canvas.width = settings.width || 640;
                canvas.height = settings.height || 480;

                // Jika mode Screen, coba aktifkan Kamera PIP
                if (mode === 'screen') {
                    try {
                        const camStream = await navigator.mediaDevices.getUserMedia({
                            video: { width: 200, facingMode: 'user' }
                        });
                        streams.push(camStream);
                        pipVideo.srcObject = camStream;
                        await pipVideo.play();
                    } catch (e) { console.log("No PIP Cam"); }
                }

                // Mulai Proses
                isRecording = true;
                drawCanvas();
                startRecorder(canvas.captureStream(30));
                updateUI(true);

            } catch (err) {
                alert("Gagal Memulai: " + err.message);
            }
        }

        // --- 3. Drawing Loop ---
        function drawCanvas() {
            if (!isRecording) return;

            // Gambar Background (Layar atau Kamera Utama)
            ctx.drawImage(sourceVideo, 0, 0, canvas.width, canvas.height);

            // Gambar PIP jika mode Screen dan ada Kamera
            if (activeMode === 'screen' && pipVideo.srcObject) {
                const w = canvas.width * 0.25;
                const h = (w/4)*3;
                const x = canvas.width - w - 20;
                const y = canvas.height - h - 20;

                ctx.save();
                ctx.strokeStyle = "white";
                ctx.lineWidth = 4;
                ctx.strokeRect(x,y,w,h);
                ctx.drawImage(pipVideo, x, y, w, h);
                ctx.restore();
            }

            animationId = requestAnimationFrame(drawCanvas);
        }

        // --- 4. Recorder ---
        function startRecorder(stream) {
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
            mediaRecorder.ondataavailable = e => { if(e.data.size > 0) chunks.push(e.data); };
            mediaRecorder.onstop = saveFile;
            mediaRecorder.start();
        }

        function stopRecording() {
            isRecording = false;
            if(mediaRecorder) mediaRecorder.stop();
            streams.forEach(s => s.getTracks().forEach(t => t.stop()));
            cancelAnimationFrame(animationId);
            updateUI(false);
        }

        function saveFile() {
            const blob = new Blob(chunks, {type: 'video/webm'});
            const url = URL.createObjectURL(blob);
            const a = document.getElementById('downloadLink');
            a.href = url;
            a.download = `Rec_${Date.now()}.mp4`;
            a.classList.remove('hidden');
            a.innerText = "Download Video Selesai";
        }

        function updateUI(recording) {
            const el = id => document.getElementById(id);
            if (recording) {
                el('placeholder').classList.add('hidden');
                el('outputCanvas').classList.remove('hidden');
                el('btnScreen').classList.add('hidden');
                el('btnCam').classList.add('hidden');
                el('pwaWarning').classList.add('hidden');
                el('btnStop').classList.remove('hidden');
            } else {
                el('btnStop').classList.add('hidden');
            }
        }
    </script>
</body>
</html>


        const btnStart = document.getElementById('btnStart');
        const btnStop = document.getElementById('btnStop');
        const btnDownload = document.getElementById('btnDownload');
        
        let mediaRecorder, chunks = [], streams = [], isRecording = false;
        let audioCtx, destNode;

        async function startRecording() {
            try {
                // Audio Context
                audioCtx = new AudioContext();
                destNode = audioCtx.createMediaStreamDestination();

                // 1. Get Screen
                const displayStream = await navigator.mediaDevices.getDisplayMedia({
                    video: { frameRate: { ideal: 30 } },
                    audio: true
                });
                screenVid.srcObject = displayStream;
                await screenVid.play();
                streams.push(displayStream);

                // Set Canvas Size dynamic
                const settings = displayStream.getVideoTracks()[0].getSettings();
                canvas.width = settings.width || window.innerWidth;
                canvas.height = settings.height || window.innerHeight;

                // Mix Screen Audio
                if (displayStream.getAudioTracks().length > 0) {
                    audioCtx.createMediaStreamSource(displayStream).connect(destNode);
                }

                displayStream.getVideoTracks()[0].onended = stopRecording;

                // 2. Get Cam & Mic
                if (document.getElementById('chkCam').checked || document.getElementById('chkMic').checked) {
                    const userStream = await navigator.mediaDevices.getUserMedia({
                        video: document.getElementById('chkCam').checked ? { facingMode: 'user', width: {ideal: 640} } : false,
                        audio: document.getElementById('chkMic').checked
                    });
                    streams.push(userStream);
                    
                    if (document.getElementById('chkCam').checked) {
                        camVid.srcObject = userStream;
                        await camVid.play();
                    }
                    if (document.getElementById('chkMic').checked) {
                        audioCtx.createMediaStreamSource(userStream).connect(destNode);
                    }
                }

                // 3. Start Loop
                isRecording = true;
                drawLoop();
                
                // 4. Start Recorder
                const canvasStream = canvas.captureStream(30);
                destNode.stream.getAudioTracks().forEach(t => canvasStream.addTrack(t));
                
                mediaRecorder = new MediaRecorder(canvasStream, { mimeType: 'video/webm;codecs=vp8' });
                mediaRecorder.ondataavailable = e => { if(e.data.size > 0) chunks.push(e.data); };
                mediaRecorder.onstop = saveFile;
                mediaRecorder.start();

                document.getElementById('instruction').classList.add('hidden');
                btnStart.classList.add('hidden');
                btnStop.classList.remove('hidden');

            } catch (err) {
                alert("Gagal: " + err.message);
            }
        }

        function drawLoop() {
            if (!isRecording) return;
            ctx.drawImage(screenVid, 0, 0, canvas.width, canvas.height);
            
            if (document.getElementById('chkCam').checked && camVid.srcObject) {
                const w = canvas.width * 0.25;
                const h = w; 
                const x = canvas.width - w - 20;
                const y = canvas.height - h - 20;
                
                ctx.save();
                ctx.beginPath();
                ctx.arc(x + w/2, y + h/2, w/2, 0, Math.PI*2);
                ctx.clip();
                ctx.drawImage(camVid, x, y, w, h);
                ctx.strokeStyle = "white";
                ctx.lineWidth = 5;
                ctx.stroke();
                ctx.restore();
            }
            requestAnimationFrame(drawLoop);
        }

        function stopRecording() {
            if (!isRecording) return;
            isRecording = false;
            mediaRecorder.stop();
            streams.forEach(s => s.getTracks().forEach(t => t.stop()));
            audioCtx.close();
            btnStop.classList.add('hidden');
        }

        function saveFile() {
            const blob = new Blob(chunks, {type: 'video/webm'});
            btnDownload.href = URL.createObjectURL(blob);
            btnDownload.download = `Rec_${Date.now()}.mp4`;
            btnDownload.classList.remove('hidden');
        }
    </script>
</body>
</html>

